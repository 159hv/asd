{% extends "base.html" %}

{% block title %}数据采集预览 - {{ system_settings.app_name }}{% endblock %}

{% block content %}
<div class="layui-card">
  <div class="layui-card-header">数据采集预览</div>
  <div class="layui-card-body">
    <form class="layui-form" id="crawlForm">
      <div class="layui-form-item">
        <label class="layui-form-label">关键字</label>
        <div class="layui-input-inline">
          <input type="text" name="q" required lay-verify="required" placeholder="请输入关键字，如：北京" autocomplete="off" class="layui-input" value="北京">
        </div>
        <button class="layui-btn" lay-submit lay-filter="crawl">预览抓取</button>
      </div>
    </form>

    <table class="layui-table" id="resultTable">
      <thead>
        <tr>
          <th>标题</th>
          <th>概要</th>
          <th>封面</th>
          <th>原始URL</th>
          <th>来源</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div style="margin-top:16px">
      <button id="toggleView" class="layui-btn layui-btn-primary">切换为美化输出</button>
    </div>
    <pre id="pretty" style="display:none; background:#1f2937; color:#e5e7eb; padding:12px; border-radius:6px; white-space:pre-wrap"></pre>
  </div>
  <div class="layui-card-body" id="debugInfo" style="display:none"></div>
</div>

<script>
var init = function(handler){
  var form = document.getElementById('crawlForm');
  form.addEventListener('submit', function(e){
    e.preventDefault();
    var q = form.querySelector('input[name="q"]').value.trim();
    handler(q);
  });
};

var render = function(items){
  var tbody = document.querySelector('#resultTable tbody');
  if(!items || items.length === 0){
    tbody.innerHTML = '<tr><td colspan="5">暂无数据</td></tr>';
    return;
  }
  var html = items.map(function(it){
    var img = it['cover'] ? '<img src="' + it['cover'] + '" style="width:80px;height:50px;object-fit:cover">' : '';
    var link = it['url'] ? '<a href="' + it['url'] + '" target="_blank">打开</a>' : '';
    return '<tr>'+
      '<td>' + (it['title']||'') + '</td>'+
      '<td>' + (it['summary']||'') + '</td>'+
      '<td>' + img + '</td>'+
      '<td>' + link + '</td>'+
      '<td>' + (it['source']||'') + '</td>'+
    '</tr>';
  }).join('');
  tbody.innerHTML = html;

  var pretty = document.getElementById('pretty');
  var lines = items.map(function(it){
    var fields = [
      '标题： ' + (it['title']||''),
      '概要： ' + (it['summary']||''),
      '封面： ' + (it['cover']||''),
      '原始URL： ' + (it['url']||''),
      '来源： ' + (it['source']||'')
    ];
    return fields.join('\n');
  }).join('\n\n');
  pretty.textContent = lines;
};

var start = function(){
  var tbody = document.querySelector('#resultTable tbody');
  init(function(kw){
    if(!kw){ return; }
    tbody.innerHTML = '<tr><td colspan="5">加载中...</td></tr>';
    fetch('/api/collect?q=' + encodeURIComponent(kw))
      .then(function(res){ return res.json(); })
      .then(function(json){ render(json.items || []); })
      .catch(function(err){ tbody.innerHTML = '<tr><td colspan="4">错误：' + err + '</td></tr>'; });
  });
  var btn = document.getElementById('toggleView');
  var pretty = document.getElementById('pretty');
  btn.addEventListener('click', function(){
    var tbl = document.getElementById('resultTable');
    var isPretty = pretty.style.display !== 'none';
    pretty.style.display = isPretty ? 'none' : 'block';
    tbl.style.display = isPretty ? 'table' : 'none';
    btn.textContent = isPretty ? '切换为美化输出' : '切换为表格输出';
  });
};

if(window.layui && window.layui.use){
  window.layui.use(['form'], function(){ start(); });
} else {
  start();
}
</script>
{% endblock %}
{% endblock %}
